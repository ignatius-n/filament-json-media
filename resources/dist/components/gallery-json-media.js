function f(s){return s?s>1e3*1e3?((s/(1e3*1e3)).toFixed(1)+" Mb").replace(".",","):s>1024?((s/1e3).toFixed(1)+" kb").replace(".",","):(s.toFixed(1)+" *kb").replace(".",","):"unknow size"}function F(s,r){return s instanceof File?{name:s.name,size:s.size,type:s.type,is_new:!0,is_success:!1,error:!1,filekey:r,progress:0,url:URL.createObjectURL(s)}:!1}function y(s){return{_minSize:null,_maxSize:null,_acceptedFileTypes:null,minSize(r){return this._minSize=r,this},maxSize(r){return this._maxSize=r,this},fileType(r){return this._acceptedFileTypes=r,this},check(){return!_(s,this.acceptedFileTypes)||!B(s,this._maxSize)||!L(s,this._minSize)}}}function m(s,r,h){let o=s.length+h;return!(r&&o>r)}function L(s,r){return!(r&&s.size>r)}function B(s,r){return!(r&&s.size>r*1024)}function _(s,r){return r?r.filter(o=>o===s.type).length>0:!0}function x(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,s=>(s^crypto.getRandomValues(new Uint8Array(1))[0]&15>>s/4).toString(16))}function M({state:s,statePath:r,minSize:h,maxSize:o,maxFiles:c,isMultiple:E,isDeletable:v,isDisabled:T,isDownloadable:A,uploadingMessage:w,isReorderable:b,acceptedFileTypes:S,hasCustomPropertiesAction:D,deleteUploadedFileUsing:$,getUploadedFilesUsing:k,removeUploadedFileUsing:U,customPropertyActionName:I,reorderUploadedFilesUsing:O}){return{state:s,statePath:r,customPropertyActionName:I,hasCustomPropertiesAction:D,isDeletable:v,isReorderable:b,lastState:null,uploadFiles:[],uploadedFileIndex:{},editingFile:{},startUpload:!1,fileKeyIndex:{},progress:0,_startSwipeX:0,stopDragging:!1,getHumanSize(e){return f(e)},uploadUsing:(e,t,i,n,g,d)=>{this.$wire.upload(`${r}.${e}`,t,p=>{i(d)},()=>{n(d)},p=>{g(d,p)})},getFileName:function(e){if(e.startsWith("blob:")||e.startsWith("livewire:"))return e;let t=e.lastIndexOf("/");return t!==-1?e.slice(t+1):e},saveFilesUsing(e){let t=this.$refs.galleryImages,i=function(l){l.uploadFiles.filter(z=>z.is_success===!1).length===0&&(l.dispatchFormEvent("form-processing-finished"),l.startUpload=!1)},n=l=>{this.uploadFiles[l].is_success=!0,this.uploadFiles[l].progress=0,i(this)},g=l=>{this.uploadFiles[l].progress=0,this.uploadFiles[l].error=!0,i(this)},d=(l,a)=>{this.uploadFiles[l].progress=a.detail.progress},p=this.uploadFiles.length,u=0;if(p){if(!m(e,c,p)){new Notification().title("Max Files reach").danger().send();return}this.startUpload||this.dispatchFormEvent("form-processing-started",{message:w}),this.startUpload=!0;for(let l of Array.from(e)){if(y(l).fileType(S).maxSize(o).minSize(h).check())continue;let a=F(l,x());a&&(this.uploadFiles.push({...a}),this.uploadUsing(a.filekey,l,n,g,d,this.uploadFiles.length-1),u++)}setTimeout(()=>{t.scrollTo({left:t.scrollWidth,behavior:"smooth"})},30),u===0&&(this.startUpload=!1,this.dispatchFormEvent("form-processing-finished"))}},laFileInput:{async"@change"(){let e=this.$event.target.files;await this.saveFilesUsing(e)}},onScrolling:{"@wheel.stop"(e){let t=Object.entries(this.uploadFiles).length,i=this.$refs.galleryImages;if(t*320>i.clientWidth){e.preventDefault();let n=e.deltaY<0?-300:300;(e.deltaY>0&&i.scrollLeft>=0&&i.scrollLeft+n<i.clientWidth||e.deltaY<0&&i.scrollLeft>0)&&i.scrollTo({left:i.scrollLeft+n,behavior:"smooth"})}}},pointerNone:{"@pointerenter"(e){let t=this.$refs.galleryImages;t.style.pointerEvents="none"},"@pointerleave"(e){let t=this.$refs.galleryImages;t.style.pointerEvents="auto"}},dropZone:{"@click.prevent.stop"(){this.$refs.laFileInput.click()},"@dragover.prevent.stop"(){this.$event.target.classList.contains("la-dropZone")},async"@drop.prevent.stop"(){this.$event.target.classList.contains("la-dropzone")&&(await this.saveFilesUsing(this.$event.dataTransfer.files),this.$refs.dropzone.classList.remove("border-primary-500","text-primary-500"),this.$refs.ladroptitle.classList.remove("pointer-events-none"),this.$refs.ladroptitle.classList.add("pointer-events-auto"))},"@dragenter.prevent.stop"(){this.$refs.dropzone.classList.add("border-primary-500","text-primary-500"),this.$refs.ladroptitle.classList.remove("pointer-events-auto"),this.$refs.ladroptitle.classList.add("pointer-events-none")},"@dragleave.prevent.stop"(){return this.$event.target===this.$refs.dropzone&&this.$refs.dropzone.classList.remove("border-primary-500","text-primary-500"),!1}},leftArrow:{"@click.stop"(){let e=Object.entries(this.uploadFiles).length,t=this.$refs.galleryImages;t.scrollLeft>0&&t.scroll({left:t.scrollLeft-300,behavior:"smooth"})}},rightArrow:{"@click.stop"(){let e=this.$refs.galleryImages;e.scrollLeft+e.clientWidth<e.scrollWidth&&e.scroll({left:e.scrollLeft+300,behavior:"smooth"})}},removeUploadFile:async function(e,t){await U(e),this.uploadFiles.splice(t,1)},deleteUploadFile:async function(e,t){await $(e),this.uploadFiles.splice(t,1)},getImageWrapperElementFromKey(e){return this.$refs.galleryImages.querySelector(`div[id="id_${e.replaceAll("-","")}"]`)},getUploadedFiles:async function(){let e=await k();this.fileKeyIndex=e??{},this.uploadedFileIndex=Object.entries(this.fileKeyIndex).filter(([t,i])=>i?.url).reduce((t,[i,n])=>(t[n.url]=i,t),{})},async getFiles(){return await this.getUploadedFiles(),Object.entries(this.fileKeyIndex).reduce((e,[t,i])=>(i.error=!1,i.is_success=!0,i.is_new=!1,i.filekey=t,e.push({...i}),e),[])},getUpdateFileEntries:function(){return Object.entries(this.state).map((e,t)=>(delete e.deleted,{key:e}))},dispatchFormEvent:function(e,t={}){this.$el.closest("form")?.dispatchEvent(new CustomEvent(e,{composed:!0,cancelable:!0,detail:t}))},canUpload:function(){return c?Object.entries(this.uploadFiles).length<=c:!0},init(){this.$watch("state",async()=>{if(this.state!==void 0){if(this.state!==null&&Object.values(this.state).filter(e=>e.file.startsWith("livewire-file:")).length){this.lastState=null;return}JSON.stringify(this.getUpdateFileEntries())!==this.lastState&&(this.lastState=JSON.stringify(this.getUpdateFileEntries()),this.uploadFiles=await this.getFiles())}}),this.$watch("sortKeys",async()=>{await O(this.sortKeys)}),this.$nextTick(async()=>{this.uploadFiles=await this.getFiles()})},dropcheck:0,usedKeyboard:!1,originalIndexBeingDragged:null,indexBeingDragged:null,indexBeingDraggedOver:null,preDragOrder:null,sortKeys:null,dragstart(e){this.preDragOrder=[...this.uploadFiles],this.indexBeingDragged=e.target.getAttribute("x-ref"),this.originalIndexBeingDragged=e.target.getAttribute("x-ref"),e.dataTransfer.dropEffect="copy"},updateListOrder(e){if(this.indexBeingDragged){this.indexBeingDraggedOver=e.target.getAttribute("x-ref");let t=this.indexBeingDragged,i=this.indexBeingDraggedOver;if(this.indexBeingDragged===i||t===i)return;this.move(t,i),this.indexBeingDragged=i}},setParentDraggable(e){e.target.closest("li").setAttribute("draggable",!0)},setParentNotDraggable(e){e.target.closest("li").setAttribute("draggable",!1)},resetState(){this.dropcheck=0,this.indexBeingDragged=null,this.preDragOrder=[...this.uploadFiles],this.indexBeingDraggedOver=null,this.originalIndexBeingDragged=null},revertState(){this.uploadFiles=this.preDragOrder.length?this.preDragOrder:this.uploadFiles,this.resetState()},rePositionPlaceholder(){this.uploadFiles=[...this.preDragOrder],this.indexBeingDragged=this.originalIndexBeingDragged},move(e,t){let i=this.uploadFiles;if(t>=i.length){let n=t-i.length+1;for(;n--;)i.push(void 0)}i.splice(t,0,i.splice(e,1)[0]),this.uploadFiles=i},getSort(){if(this.indexBeingDragged===this.originalIndexBeingDragged)return null;this.sortKeys=this.uploadFiles.map(e=>e.filekey)}}}export{M as galleryFileUpload};
